<!DOCTYPE html>
<html>
<head>
    <title>Post Button Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        button { padding: 10px 20px; margin: 10px; }
        .result { margin: 10px 0; padding: 10px; background: #f5f5f5; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>Post Button Debug Tool</h1>
    
    <div class="test-section">
        <h3>Test 1: Check Authentication</h3>
        <button onclick="testAuth()">Check Auth Status</button>
        <div id="auth-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: Create Text-Only Post</h3>
        <button onclick="testTextPost()">Create Text Post</button>
        <div id="text-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: Create Post with Image</h3>
        <input type="file" id="file-input" accept="image/*,video/*">
        <button onclick="testMediaPost()">Create Media Post</button>
        <div id="media-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Console Logs</h3>
        <div id="console-logs" class="result" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
    </div>

    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const logsDiv = document.getElementById('console-logs');
        
        function addLog(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? 'red' : 'black';
            logEntry.textContent = `[${timestamp}] ${type.toUpperCase()}: ${args.join(' ')}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = (...args) => {
            originalLog(...args);
            addLog('log', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            addLog('error', ...args);
        };

        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            resultDiv.textContent = 'Testing authentication...';
            
            try {
                const response = await fetch('/api/auth/session');
                const session = await response.json();
                
                if (session?.user) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ✅ Authenticated as: ${session.user.email || session.user.name}<br>
                        User ID: ${session.user.id}
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '❌ Not authenticated';
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Auth check failed: ${error.message}`;
            }
        }

        async function testTextPost() {
            const resultDiv = document.getElementById('text-result');
            resultDiv.textContent = 'Creating text post...';
            
            try {
                const formData = new FormData();
                formData.append('content', `Test text post created at ${new Date().toLocaleString()}`);
                formData.append('isInvite', 'false');
                
                console.log('Sending text post request...');
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ✅ Text post created successfully!<br>
                        Post ID: ${result.post?.id}<br>
                        Content: ${result.post?.content}
                    `;
                    console.log('Text post result:', result);
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ Failed: ${response.status} - ${errorText}`;
                    console.error('Text post failed:', errorText);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Error: ${error.message}`;
                console.error('Text post error:', error);
            }
        }

        async function testMediaPost() {
            const resultDiv = document.getElementById('media-result');
            const fileInput = document.getElementById('file-input');
            
            if (!fileInput.files[0]) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '❌ Please select a file first';
                return;
            }
            
            const file = fileInput.files[0];
            resultDiv.textContent = 'Creating media post...';
            
            try {
                const formData = new FormData();
                formData.append('content', `Test media post created at ${new Date().toLocaleString()}`);
                formData.append('media', file);
                formData.append('isInvite', 'false');
                
                console.log('Sending media post request with file:', {
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
                
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ✅ Media post created successfully!<br>
                        Post ID: ${result.post?.id}<br>
                        Content: ${result.post?.content}<br>
                        Image URL: ${result.post?.image || 'None'}<br>
                        Video URL: ${result.post?.video || 'None'}
                    `;
                    console.log('Media post result:', result);
                } else {
                    const errorText = await response.text();
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `❌ Failed: ${response.status} - ${errorText}`;
                    console.error('Media post failed:', errorText);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `❌ Error: ${error.message}`;
                console.error('Media post error:', error);
            }
        }

        // Auto-test auth on page load
        window.onload = () => {
            testAuth();
        };
    </script>
</body>
</html>