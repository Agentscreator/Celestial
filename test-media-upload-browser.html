<!DOCTYPE html>
<html>
<head>
    <title>Media Upload Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 400px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Media Upload Debug Test</h1>
    
    <div class="test-section">
        <h3>Test Controls</h3>
        <button onclick="testTextPost()">Test Text-Only Post</button>
        <button onclick="testSmallMediaPost()">Test Small Media Post</button>
        <button onclick="testRecordedVideo()">Test Recorded Video</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div class="test-section">
        <h3>Test Log</h3>
        <div id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Test 1: Text-only post
        async function testTextPost() {
            log('üîç Testing text-only post...', 'info');
            
            try {
                const formData = new FormData();
                formData.append('content', 'Text-only test post ' + Date.now());
                formData.append('isInvite', 'false');

                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData,
                });

                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Text post successful!', 'success');
                    log(`Post ID: ${result.post?.id}`, 'info');
                    log(`Content: ${result.post?.content}`, 'info');
                } else {
                    const errorText = await response.text();
                    log('‚ùå Text post failed: ' + errorText.substring(0, 200), 'error');
                }
            } catch (error) {
                log('‚ùå Text post error: ' + error.message, 'error');
            }
        }

        // Test 2: Small media post
        async function testSmallMediaPost() {
            log('üé¨ Testing small media post...', 'info');
            
            try {
                // Create a small test video blob
                const testData = 'fake video data for testing';
                const blob = new Blob([testData], { type: 'video/mp4' });
                const file = new File([blob], 'test-video.mp4', { 
                    type: 'video/mp4',
                    lastModified: Date.now()
                });

                log(`Created test file: ${file.name}, ${file.size} bytes, ${file.type}`, 'info');

                const formData = new FormData();
                formData.append('content', 'Small media test post ' + Date.now());
                formData.append('media', file);
                formData.append('isInvite', 'false');

                log('Sending request to /api/posts...', 'info');
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData,
                });

                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Media post successful!', 'success');
                    log(`Post ID: ${result.post?.id}`, 'info');
                    log(`Content: ${result.post?.content}`, 'info');
                    log(`Image URL: ${result.post?.image || 'none'}`, result.post?.image ? 'success' : 'error');
                    log(`Video URL: ${result.post?.video || 'none'}`, result.post?.video ? 'success' : 'error');
                    
                    if (!result.post?.image && !result.post?.video) {
                        log('‚ö†Ô∏è NO MEDIA URL RETURNED - This is the problem!', 'error');
                    }
                } else {
                    const errorText = await response.text();
                    log('‚ùå Media post failed: ' + errorText.substring(0, 300), 'error');
                }
            } catch (error) {
                log('‚ùå Media post error: ' + error.message, 'error');
            }
        }

        // Test 3: Recorded video (simulate camera recording)
        async function testRecordedVideo() {
            log('üìπ Testing recorded video simulation...', 'info');
            
            try {
                // Create a canvas and draw something
                const canvas = document.createElement('canvas');
                canvas.width = 320;
                canvas.height = 240;
                const ctx = canvas.getContext('2d');
                
                // Draw a test pattern
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 160, 120);
                ctx.fillStyle = 'blue';
                ctx.fillRect(160, 0, 160, 120);
                ctx.fillStyle = 'green';
                ctx.fillRect(0, 120, 160, 120);
                ctx.fillStyle = 'yellow';
                ctx.fillRect(160, 120, 160, 120);
                
                // Add some text
                ctx.fillStyle = 'black';
                ctx.font = '20px Arial';
                ctx.fillText('Test Video', 100, 130);

                // Convert to blob (simulating recorded video)
                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, 'video/webm', 0.8);
                });

                if (!blob) {
                    log('‚ùå Failed to create video blob', 'error');
                    return;
                }

                const file = new File([blob], `recorded-video-${Date.now()}.webm`, { 
                    type: 'video/webm',
                    lastModified: Date.now()
                });

                log(`Created recorded video: ${file.name}, ${file.size} bytes, ${file.type}`, 'info');

                const formData = new FormData();
                formData.append('content', 'Recorded video test post ' + Date.now());
                formData.append('media', file);
                formData.append('isInvite', 'false');

                log('Sending recorded video to /api/posts...', 'info');
                const response = await fetch('/api/posts', {
                    method: 'POST',
                    body: formData,
                });

                log(`Response status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Recorded video post successful!', 'success');
                    log(`Post ID: ${result.post?.id}`, 'info');
                    log(`Content: ${result.post?.content}`, 'info');
                    log(`Image URL: ${result.post?.image || 'none'}`, result.post?.image ? 'success' : 'error');
                    log(`Video URL: ${result.post?.video || 'none'}`, result.post?.video ? 'success' : 'error');
                    
                    if (!result.post?.image && !result.post?.video) {
                        log('‚ö†Ô∏è NO MEDIA URL RETURNED - This is the problem!', 'error');
                    } else {
                        log('üéâ Media URL was created successfully!', 'success');
                    }
                } else {
                    const errorText = await response.text();
                    log('‚ùå Recorded video post failed: ' + errorText.substring(0, 300), 'error');
                }
            } catch (error) {
                log('‚ùå Recorded video error: ' + error.message, 'error');
            }
        }

        // Auto-run text test on page load
        window.onload = function() {
            log('üöÄ Media Upload Debug Test loaded', 'info');
            log('Click the buttons above to run different tests', 'info');
        };
    </script>
</body>
</html>